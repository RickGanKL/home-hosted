ARG ARCH=amd64
FROM ${ARCH}/node:8-alpine

RUN mkdir -p /usr/src/app

COPY config.docker.js /tmp/config.js

# Install runtime dependencies and remove state generated by apk before
# creating intermediate image.
RUN apk -U upgrade \
    && apk add --no-cache --virtual .build-deps \
        git \
        python \
        make \
        g++ \
        build-base \
    && git clone --depth 1 https://github.com/jfurrow/flood /usr/src/app \
    && cd /usr/src/app \
    && npm install && npm cache clean --force \
    && mv /tmp/config.js /usr/src/app/config.js \
    && npm run build \
    && rm -rf /var/cache/apk/* /tmp/* \
    && apk del --force \
        .build-deps

# Create app working directory.
WORKDIR /usr/src/app

# Hints for consumers of the container.
EXPOSE 3000
VOLUME ["/data"]

# Start application.
CMD [ "npm", "start" ]
